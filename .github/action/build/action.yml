name: build
description: build with cache
inputs:
  CMAKE_ARGS:
    description: "CMake Arguments"
    required: false
    default: ""
  CMAKE_BUILD_ARGS:
    description: "CMake Build Arguments"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - if: runner.os == 'Linux'
      shell: bash
      run: |
        set -ex
        sudo rm /var/lib/man-db/auto-update
        sudo apt-get update
        sudo apt-get install -y ccache cmake ninja-build
    - if: runner.os == 'macOS'
      shell: bash
      run: |
        set -ex
        brew update
        brew install ccache cmake ninja
      env:
        HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
        HOMEBREW_NO_AUTO_UPDATE: 1
        HOMEBREW_NO_INSTALL_CLEANUP: 1
    - if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install ccache ninja -y
    - if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
    - if: runner.os == 'Windows'
      shell: pwsh
      run: |
        echo "CMAKE_C_COMPILER=cl" >> $env:GITHUB_ENV
        echo "CMAKE_CXX_COMPILER=cl" >> $env:GITHUB_ENV
    - shell: bash
      run: |
        set -ex
        echo "CCACHE_DIR=$(pwd)/build_cache" >> $GITHUB_ENV
        mkdir -p build_cache
        # Configure ccache for better MSVC compatibility and debugging
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "CCACHE_SLOPPINESS=include_file_mtime,include_file_ctime,time_macros,pch_defines,file_stat_matches" >> $GITHUB_ENV
          echo "CCACHE_BASEDIR=$(pwd)" >> $GITHUB_ENV
          echo "CCACHE_DEBUG=1" >> $GITHUB_ENV
          echo "CCACHE_LOGFILE=$(pwd)/ccache.log" >> $GITHUB_ENV
        fi
    - uses: actions/cache@v4
      with:
        path: build_cache
        key: ccache-${{ runner.os }}-${{ inputs.CMAKE_ARGS }}-${{ github.run_id }}
        restore-keys: |
          ccache-${{ runner.os }}-${{ inputs.CMAKE_ARGS }}-
          ccache-${{ runner.os }}-
    - shell: bash
      run: |
        ccache --max-size=512M
        ccache --zero-stats
    - name: install assemblyscript deps
      run: npm ci
      shell: bash
      working-directory: assemblyscript

    - name: build
      run: |
        set -ex
        cmake -B build -S . ${{ inputs.CMAKE_ARGS }}
        cmake --build build --parallel ${{ inputs.CMAKE_BUILD_ARGS }}
      shell: bash
      env:
        CMAKE_GENERATOR: Ninja
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache
    - shell: bash
      run: |
        ccache --show-stats
        # Save detailed info for Windows artifact
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "=== Detailed ccache statistics ==="
          ccache --show-stats --verbose
          echo "=== ccache configuration ===" > ccache-config.txt
          ccache --show-config >> ccache-config.txt
          echo "=== ccache statistics ===" > ccache-stats.txt
          ccache --show-stats --verbose >> ccache-stats.txt
        fi
    - name: Upload ccache debug log
      if: runner.os == 'Windows' && always()
      uses: actions/upload-artifact@v4
      with:
        name: ccache-debug-log-${{ runner.os }}-${{ github.run_number }}
        path: |
          ccache.log
          ccache-config.txt
          ccache-stats.txt
        retention-days: 7
        if-no-files-found: warn
